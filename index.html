<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Weather — iOS style</title>
  <style>
    :root{
      --glass: rgba(255,255,255,.14);
      --glass-soft: rgba(255,255,255,.12);
      --muted:#cfd6de;
      --text:#ffffff;
    }

    /* ===== THEME (dark / light) + dynamic background ===== */
    body[data-theme="dark"]{
      --text:#ffffff;
      --muted:#cfd6de;
      --glass: rgba(255,255,255,.14);
      --glass-soft: rgba(255,255,255,.12);

      --bg-radial:#48566a;
      --bg-top:#1f2834;
      --bg-mid:#2b3a4a;
      --bg-bottom:#2e3641;

      --glow: rgba(124,164,255,.22);
      --stars-opacity: .45;
    }
    body[data-theme="light"]{
      --text:#0b1220;
      --muted:#526170;
      --glass: rgba(255,255,255,.50);
      --glass-soft: rgba(255,255,255,.36);

      --bg-radial:#ffffff;
      --bg-top:#e8f1ff;
      --bg-mid:#d6e7ff;
      --bg-bottom:#c7dcff;

      --glow: rgba(255,255,255,.65);
      --stars-opacity: 0;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, Arial, sans-serif;
      color:var(--text);
      min-height:100vh;

      background:
        radial-gradient(1200px 600px at 70% -100px, var(--bg-radial) 0%, rgba(0,0,0,0) 70%),
        linear-gradient(180deg, var(--bg-top) 0%, var(--bg-mid) 60%, var(--bg-bottom) 100%);
      background-attachment: fixed, fixed;
      background-size: 120% 120%, 100% 100%;
      animation: drift 40s ease-in-out infinite;
      position: relative;
      overflow-x:hidden;
    }

    /* ---------- SKY SPRITES PER THEME ---------- */

    /* กลางคืน: เนบิวล่าพลิ้ว + ดาวจำนวนมากระยิบระยับ + พารัลแลกซ์เล็กน้อย */
    body[data-theme="dark"]::before{
      content:"";
      position: fixed;
      inset:-25% -10% auto -10%;
      height:150vh;
      pointer-events:none;
      background:
        radial-gradient(700px 420px at 68% 0%, var(--glow) 0%, rgba(255,255,255,0) 70%),
        radial-gradient(520px 320px at 20% 30%, rgba(255,255,255,.10) 0%, rgba(255,255,255,0) 70%);
      filter: blur(0.5px);
      mix-blend-mode: screen;
      animation: float1 24s ease-in-out infinite alternate;
      opacity:.9;
    }
    body[data-theme="dark"]::after{
      content:"";
      position: fixed;
      inset:-2% -2% -2% -2%;
      pointer-events:none;
      /* สร้างดาวสองชั้น (เม็ดเล็ก/ใหญ่) หลายจุด */
      background-image:
        radial-gradient(1px 1px at 5% 12%,  rgba(255,255,255,.95) 0, transparent 2px),
        radial-gradient(1.2px 1.2px at 12% 32%, rgba(255,255,255,.85) 0, transparent 2.2px),
        radial-gradient(1px 1px at 18% 68%, rgba(255,255,255,.9) 0, transparent 2px),
        radial-gradient(1.4px 1.4px at 28% 22%, rgba(255,255,255,.8) 0, transparent 2.4px),
        radial-gradient(1.2px 1.2px at 34% 78%, rgba(255,255,255,.9) 0, transparent 2.2px),
        radial-gradient(1px 1px at 42% 18%, rgba(255,255,255,.8) 0, transparent 2px),
        radial-gradient(1.4px 1.4px at 52% 62%, rgba(255,255,255,.85) 0, transparent 2.4px),
        radial-gradient(1px 1px at 60% 30%, rgba(255,255,255,.9) 0, transparent 2px),
        radial-gradient(1.2px 1.2px at 66% 80%, rgba(255,255,255,.85) 0, transparent 2.2px),
        radial-gradient(1px 1px at 74% 40%, rgba(255,255,255,.95) 0, transparent 2px),
        radial-gradient(1.4px 1.4px at 82% 72%, rgba(255,255,255,.9) 0, transparent 2.4px),
        radial-gradient(1px 1px at 90% 20%, rgba(255,255,255,.85) 0, transparent 2px),

        radial-gradient(2px 2px at 8% 55%,   rgba(255,255,255,.6) 0, transparent 3px),
        radial-gradient(2px 2px at 26% 12%,  rgba(255,255,255,.6) 0, transparent 3px),
        radial-gradient(2px 2px at 38% 46%,  rgba(255,255,255,.6) 0, transparent 3px),
        radial-gradient(2px 2px at 58% 14%,  rgba(255,255,255,.6) 0, transparent 3px),
        radial-gradient(2px 2px at 72% 58%,  rgba(255,255,255,.6) 0, transparent 3px),
        radial-gradient(2px 2px at 88% 36%,  rgba(255,255,255,.6) 0, transparent 3px);
      opacity: var(--stars-opacity);
      animation: twinkle 2.8s ease-in-out infinite alternate, starDrift 60s linear infinite;
    }

    /* --------- โหมดกลางวัน (LIGHT): เมฆสีขาวแบบไดนามิก เลเยอร์หลังสุด --------- */
    /* ย้าย “เมฆ” ไปไว้ที่ ::before เพื่อให้เป็นเลเยอร์หลังสุด และเอาดวงอาทิตย์ออก */
    body[data-theme="light"]::before{
      content:"";
      position: fixed;
      inset:-10% -10% -5% -10%;
      pointer-events:none;
      /* เมฆ 3 ชั้น (ก้อนนุ่ม) */
      background:
        /* ชั้นไกล */
        radial-gradient(90px 45px at 10% 18%, rgba(255,255,255,.45) 60%, rgba(255,255,255,0) 61%),
        radial-gradient(120px 60px at 16% 20%, rgba(255,255,255,.45) 60%, rgba(255,255,255,0) 61%),
        radial-gradient(100px 50px at 22% 18%, rgba(255,255,255,.45) 60%, rgba(255,255,255,0) 61%),

        /* ชั้นกลาง */
        radial-gradient(120px 60px at 50% 22%, rgba(255,255,255,.55) 60%, rgba(255,255,255,0) 61%),
        radial-gradient(140px 70px at 58% 24%, rgba(255,255,255,.55) 60%, rgba(255,255,255,0) 61%),
        radial-gradient(110px 55px at 66% 22%, rgba(255,255,255,.55) 60%, rgba(255,255,255,0) 61%),

        /* ชั้นใกล้ */
        radial-gradient(150px 80px at 78% 34%, rgba(255,255,255,.65) 60%, rgba(255,255,255,0) 61%),
        radial-gradient(170px 90px at 88% 36%, rgba(255,255,255,.65) 60%, rgba(255,255,255,0) 61%),
        radial-gradient(130px 70px at 70% 38%, rgba(255,255,255,.65) 60%, rgba(255,255,255,0) 61%);
      filter: blur(0.3px);
      animation: cloudsDrift 60s linear infinite;
      opacity:.9;
      z-index:0; /* หลังสุดใต้คอนเทนต์ */
    }
    /* ปิดเลเยอร์ ::after เดิมในโหมด light (ไม่มีดวงอาทิตย์/เอฟเฟกต์อื่น) */
    body[data-theme="light"]::after{ content:none; }

    .wrap{
      max-width:960px; margin:0 auto; padding:18px;
      /* ทำให้คอนเทนต์อยู่เหนือก้อนเมฆและดาวเสมอ */
      position:relative; z-index:1;
    }
    .top{padding:18px 8px 8px; text-align:center}
    .city{font-size:1.6rem; letter-spacing:.5px}
    .temp{font-size:6rem; font-weight:200; margin:.2rem 0}
    .desc{color:var(--muted); font-size:1.05rem}
    .toolbar{display:flex; gap:.6rem; justify-content:center; align-items:center; margin-top:8px}
    select, button{
      padding:.55rem .8rem; border-radius:12px; border:1px solid rgba(255,255,255,.18);
      background:var(--glass-soft); color:var(--text); backdrop-filter: blur(6px);
    }
    button{ border:0; cursor:pointer }
    .card{
      background:var(--glass); border:1px solid rgba(255,255,255,.18); border-radius:18px;
      padding:12px 14px; backdrop-filter: blur(8px);
    }
    .alert{ margin:12px auto 8px; max-width:780px }
    .alert-title{ display:flex; align-items:center; gap:.5rem; font-weight:600 }
    .alert small{ color:var(--muted) }
    .section-title{ margin:12px 0 6px 6px; font-weight:600; opacity:.95 }
    .scroll{ display:flex; gap:10px; overflow-x:auto; padding:6px }
    .hcard{ min-width:70px; text-align:center }
    .h-time{ color:var(--muted); font-size:.95rem }
    .h-emoji{ font-size:1.25rem; margin:.15rem 0 }
    .h-temp{ font-size:1.1rem }
    .h-pop{ color:var(--muted); font-size:.9rem }

    .daily{ display:flex; flex-direction:column; gap:8px; padding:6px }
    .drow{
      display:grid;
      /* ชื่อวัน | Tmin | แถบอุณหภูมิ | Tmax | %ฝน(+อีโมจิ) */
      grid-template-columns: 64px 56px 1fr 56px 72px;
      align-items:center;
      gap:8px;
    }
    .pop{
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap:6px;
    }
    .d-min{ text-align:right;  opacity:.95; }
    .d-max{ text-align:left;   opacity:.95; }
    .d-name{ color: var(--text); opacity:.95 }   /* ใช้สีตามธีม */

    .bar{
      position:relative; height:8px; background:rgba(255,255,255,.12); border-radius:999px; overflow:hidden;
    }
    .bar-fill{
      position:absolute; height:100%; background:#f39c12; border-radius:999px;
    }
    .muted{ color:var(--muted) }
    .forecast-note{ text-align:center; margin:10px 0 0; color:var(--muted) }
    .footer{ text-align:center; color:var(--muted); margin:16px 0 8px }

    /* keyframes */
    @keyframes drift{
      0%   { background-position: 0% 0%, 0% 0%; }
      50%  { background-position: 100% 50%, 0% 0%; }
      100% { background-position:   0% 0%, 0% 0%; }
    }
    @keyframes float1{
      0%   { transform: translate(-4%, -2%) scale(1);   opacity:.85; }
      100% { transform: translate( 8%,  4%) scale(1.12); opacity:1; }
    }
    @keyframes twinkle{
      0%,100% { opacity: calc(var(--stars-opacity) * .6); }
      50%     { opacity: calc(var(--stars-opacity) * 1.0); }
    }
    @keyframes starDrift{
      0%   { transform: translate3d(-1%,0,0); }
      100% { transform: translate3d( 1%,0,0); }
    }
    @keyframes sunFloat{
      0%   { transform: translate3d(-1%, -1%, 0) scale(1);   }
      100% { transform: translate3d( 2%,  2%, 0) scale(1.04); }
    }
    @keyframes cloudsDrift{
      0%   { transform: translate3d(-4%,0,0); }
      100% { transform: translate3d( 4%,0,0); }
    }

    /* ====== เพิ่มตามที่ขอ (คงเดิมจากเวอร์ชั่นก่อน) ====== */
    body[data-theme="light"] .d-name{ color:#000; }
    body[data-theme="light"] .toolbar label{ color:#000; }
    body[data-theme="light"] .toolbar select{ color:#000; }
    body[data-theme="light"] .toolbar option{ color:#000; }
    body[data-theme="dark"]  .toolbar option{ color:#fff; background:#2e3641; }
    body[data-theme="dark"]  .toolbar select{ color:#fff; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div style="font-size:.95rem; color:var(--muted)" id="clock">--:--</div>
      <div class="city" id="city">—</div>
      <div class="temp"><span id="temp">--</span>°</div>
      <div class="desc"><span id="desc">โหลดข้อมูล...</span></div>
      <div class="toolbar">
        <label for="citySel" class="muted">City</label>
        <select id="citySel"></select>
        <button id="btnReload">โหลดข้อมูล</button>

        <!-- Theme selector -->
        <label for="themeSel" class="muted">Theme</label>
        <select id="themeSel">
          <option value="auto">Auto</option>
          <option value="light">Light</option>
          <option value="dark">Dark</option>
        </select>
      </div>
    </div>

    <div id="alertBox" class="card alert" style="display:none">
      <div class="alert-title"><span id="alertTitle">คำเตือนเรื่องฝนตกหนัก</span></div>
      <small id="alertSub" class="muted">ประกาศ: โอกาสฝนตกสูงจากพยากรณ์รายวัน</small>
    </div>

    <div id="rainHint" class="card alert" style="display:none"></div>

    <div>
      <div class="section-title">พยากรณ์อากาศรายชั่วโมง</div>
      <div class="card scroll" id="hourly"></div>
    </div>

    <div>
      <div class="section-title">พยากรณ์อากาศ 7 วัน</div>
      <div class="card daily" id="daily"></div>
      <p class="forecast-note"></p>
    </div>

    <div class="footer">แหล่งข้อมูล: Open-Meteo • Dev by Sunisa & Adil</div>
  </div>

<script>
  const API = `${location.protocol}//${location.hostname}:5002`;

  function pad2(n){ return String(n).padStart(2,"0"); }
  function updateClock(){
    const d = new Date();
    document.getElementById("clock").textContent = `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
  }
  setInterval(updateClock, 1000); updateClock();

  // ====== THEME ENGINE ======
  let themeTimer = null;
  function pickThemeByTime(){
    const h = new Date().getHours();
    return (h >= 6 && h < 18) ? "light" : "dark";
  }
  function applyThemeMode(mode){
    const m = mode || "auto";
    localStorage.setItem("themeMode", m);
    if (themeTimer){ clearInterval(themeTimer); themeTimer = null; }

    if (m === "light" || m === "dark"){
      document.body.setAttribute("data-theme", m);
    } else {
      const tick = () => document.body.setAttribute("data-theme", pickThemeByTime());
      tick();
      themeTimer = setInterval(tick, 60 * 1000);
    }
  }

  // ====== DATA HELPERS ======
  async function loadCities(){
    const res = await fetch(`${API}/api/cities`);
    const { ok, cities } = await res.json();
    const sel = document.getElementById("citySel");
    sel.innerHTML = "";
    (cities||[]).forEach(c=>{
      const opt=document.createElement("option");
      opt.value=c.key; opt.textContent=c.nameTH; sel.appendChild(opt);
    });
    sel.value = "bangkok";
  }

  function buildDailyBars(days){
    const allMin = Math.min(...days.map(d=>d.tmin));
    const allMax = Math.max(...days.map(d=>d.tmax));
    return days.map(d=>{
      const left  = ((d.tmin - allMin) / (allMax - allMin + 0.0001)) * 100;
      const right = ((d.tmax - allMin) / (allMax - allMin + 0.0001)) * 100;
      return { ...d, left, width: Math.max(6, right-left) };
    });
  }

  function wmoToShortTH(code){
    const c=Number(code);
    if (c===0) return "แจ่มใส";
    if (c===1) return "มีเมฆบางส่วน";
    if (c===2) return "เมฆเป็นส่วนมาก";
    if (c===3) return "มีเมฆมาก";
    if ([51,53,55,61,63,65,80,81,82].includes(c)) return "ฝนตก";
    if ([95,96,99].includes(c)) return "พายุฝนฟ้าคะนอง";
    if ([45,48].includes(c)) return "มีหมอก";
    if ([71,73,75,77,85,86].includes(c)) return "หิมะตก";
    return "สภาพอากาศ";
  }

  function addCard(parent, label, icon, temp, pop){
    const div = document.createElement("div");
    div.className = "hcard";
    const tempTxt = (temp==null || Number.isNaN(temp)) ? "—" : Math.round(temp);
    const popTxt  = (pop==null  || Number.isNaN(pop))  ? 0   : Math.round(pop);
    div.innerHTML = `
      <div class="h-time">${label}</div>
      <div class="h-emoji">${icon || "🌡️"}</div>
      <div class="h-temp">${tempTxt}°</div>
      <div class="h-pop">${popTxt}%</div>
    `;
    parent.appendChild(div);
  }

  // ใช้ 24 แทน 00 (เช่น 22 23 24 1 2 ...)
  function hourLabel(dt){
    const h = dt.getHours();
    return h === 0 ? "24" : String(h);
  }

  function popToEmoji(p){
    const v = Number(p) || 0;
    if (v >= 80) return "⛈️";
    if (v >= 60) return "🌧️";
    if (v >= 40) return "🌦️";
    if (v >= 20) return "🌤️";
    return "☀️";
  }

  // ====== LOAD WEATHER ======
  async function loadWeather(){
    const city = document.getElementById("citySel").value || "bangkok";
    const res = await fetch(`${API}/api/weather?city=${encodeURIComponent(city)}`);
    const js  = await res.json();
    if(!js.ok){ alert(js.error || "โหลดข้อมูลล้มเหลว"); return; }
    const d = js.data;

    // ส่วนหัว
    document.getElementById("city").textContent = d.city_name_th;
    document.getElementById("temp").textContent = Math.round(d.current.temp ?? 0);
    document.getElementById("desc").textContent = `${wmoToShortTH(d.current.wmo)} • ลม ${Math.round(d.current.windspeed ?? 0)} km/h`;

    // กล่องเตือน
    const alertBox = document.getElementById("alertBox");
    if (d.alert){
      alertBox.style.display="block";
      document.getElementById("alertTitle").textContent = d.alert;
    } else {
      alertBox.style.display="none";
    }

    // คำใบ้ฝนถัดไป
    const hint = document.getElementById("rainHint");
    if (d.next_rain_time){
      const t = new Date(d.next_rain_time);
      hint.style.display = "block";
      hint.textContent = `คาดว่ามีฝนตก ประมาณเวลา ${pad2(t.getHours())}:00`;
    } else {
      hint.style.display = "none";
    }

    // ===== วันนี้: ตอนนี้ + 24 ชั่วโมงถัดไป =====
    const hWrap = document.getElementById("hourly");
    hWrap.innerHTML = "";

    const hours = (d.hourly || []).map(h => ({...h, dt: new Date(h.time)}));
    const now = new Date();
    const nowHour = new Date(now); nowHour.setMinutes(0,0,0);

    const idxNowHour = hours.findIndex(h => h.dt.getTime() === nowHour.getTime());
    const nowPop = idxNowHour >= 0 ? (hours[idxNowHour].precip_prob ?? 0) : 0;

    // การ์ดแรก: "ตอนนี้"
    addCard(hWrap, "ตอนนี้", d.current.icon, d.current.temp, nowPop);

    // เริ่มจากชั่วโมงถัดไป 24 ชั่วโมง
    const nextHour = new Date(nowHour); nextHour.setHours(nextHour.getHours()+1);
    let startIdx = hours.findIndex(h => h.dt.getTime() === nextHour.getTime());
    if (startIdx === -1) startIdx = hours.findIndex(h => h.dt.getTime() >= nextHour.getTime());

    if (startIdx >= 0) {
      const maxCards = 24;
      for (let i = 0; i < maxCards && (startIdx + i) < hours.length; i++) {
        const h = hours[startIdx + i];
        addCard(hWrap, hourLabel(h.dt), h.icon, h.temp, h.precip_prob);
      }
    } else {
      hours.slice(0, 24).forEach(h => {
        addCard(hWrap, hourLabel(h.dt), h.icon, h.temp, h.precip_prob);
      });
    }

    // ===== รายวัน 7 วัน: วันนี้ + ถัดไปอีก 7 วัน (รวม 8 วัน) =====
    const today = new Date();
    const todayStr = `${today.getFullYear()}-${pad2(today.getMonth()+1)}-${pad2(today.getDate())}`;

    let dayStartIdx = d.daily.findIndex(day => day.date === todayStr);
    if (dayStartIdx === -1) dayStartIdx = 0;

    const showDays = d.daily.slice(dayStartIdx, dayStartIdx + 8);
    const dailyBars = buildDailyBars(showDays);

    const dWrap = document.getElementById("daily");
    dWrap.innerHTML = "";
    dailyBars.forEach(day=>{
      const isToday = day.date === todayStr;
      const wd = isToday ? "วันนี้" : new Date(day.date).toLocaleDateString("th-TH",{weekday:"short"});
      const pop = Math.round(day.precip_prob_max ?? 0);
      const emoji = popToEmoji(pop);

      const row = document.createElement("div");
      row.className="drow";
      row.innerHTML = `
        <div class="d-name">${wd}</div>
        <div class="d-min">${Math.round(day.tmin)}°</div>
        <div class="bar"><div class="bar-fill" style="left:${day.left}%; width:${day.width}%"></div></div>
        <div class="d-max">${Math.round(day.tmax)}°</div>
        <div class="pop muted"><span>${emoji}</span><span>${pop}%</span></div>
      `;
      dWrap.appendChild(row);
    });
  }

  // ====== EVENTS & INIT ======
  document.getElementById("btnReload").addEventListener("click", loadWeather);

  (async ()=>{
    await loadCities();

    // init theme
    const themeSel = document.getElementById("themeSel");
    const savedMode = localStorage.getItem("themeMode") || "auto";
    themeSel.value = savedMode;
    themeSel.addEventListener("change", e => applyThemeMode(e.target.value));
    applyThemeMode(savedMode);

    await loadWeather();
  })();
</script>
</body>
</html>
